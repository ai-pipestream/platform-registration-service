# Application
quarkus.application.name=platform-registration-service
quarkus.application.version=@version@


# Test profile - use Quarkus DevServices (Testcontainers)
%test.quarkus.devservices.enabled=true
%test.quarkus.compose.devservices.enabled=false
%test.quarkus.kafka.devservices.enabled=true

# Service Registration Consul DevServices - only enable for platform-registration-service
# Other services don't need their own Consul, they connect to the registration service
%test.quarkus.pipestream.service.registration.devservices.consul.enabled=true
# DO NOT set kafka.bootstrap.servers for test - DevServices auto-configures it

# Random port for test
quarkus.http.test-port=0

# Apicurio Registry URL
# Extension automatically bridges apicurio.registry.url to mp.messaging.connector.smallrye-kafka.apicurio.registry.url
# Apicurio Registry DevServices automatically enabled by quarkus-apicurio-registry-protobuf extension
# No additional configuration needed for test - extension handles setup automatically
#mp.messaging.connector.smallrye-kafka.apicurio.registry.url=${apicurio.registry.url}
#%dev.apicurio.registry.url=http://localhost:8081
%prod.apicurio.registry.url=${APICURIO_REGISTRY_URL}

# Container Image Configuration
# Container image configuration - default to local Docker
quarkus.container-image.group=ai-pipestream
quarkus.container-image.name=platform-registration-service
quarkus.container-image.tag=latest
# Version-based tag is set at build time via Gradle parameter instead of token replacement
# quarkus.container-image.additional-tags=@version@

# Profile: local - build to local Docker (no registry push)
%local.quarkus.container-image.registry=
%local.quarkus.container-image.push=false

# Profile: localhost - push to localhost:5000 registry
%localhost.quarkus.container-image.registry=localhost:5000
%localhost.quarkus.container-image.push=true
%localhost.quarkus.container-image.insecure=true

# Profile: ghcr - push to GitHub Container Registry
%ghcr.quarkus.container-image.registry=ghcr.io
%ghcr.quarkus.container-image.push=true

# Profile: dockerhub - push to Docker Hub
%dockerhub.quarkus.container-image.registry=docker.io
%dockerhub.quarkus.container-image.push=true

# gRPC uses same server as HTTP
quarkus.grpc.server.use-separate-server=false
quarkus.grpc.server.enable-health-service=true

# Enable gRPC code generation from Buf-fetched proto files
# Proto files are exported to src/main/proto by syncProtos task
quarkus.grpc.codegen.skip=false
#
# Parent-first artifacts (gRPC, Protobuf, etc.) are automatically configured by pipeline-protobuf-kafka-connector extension
# No manual configuration needed - the extension handles all classloading automatically

# HTTP Configuration (also serves gRPC)
quarkus.http.port=38101
quarkus.http.root-path=/platform-registration
%dev.quarkus.http.port=38101
%dev.quarkus.http.host=0.0.0.0

# Database
quarkus.datasource.db-kind=postgresql

# Dev Services timeout
%dev.quarkus.devservices.timeout=120s

# Note: The quarkus-pipeline-devservices extension extracts the compose file to ~/.pipeline/
# but does NOT configure Quarkus Compose Dev Services automatically. You must add the properties below.

# Compose Dev Services - Enable shared infrastructure for dev mode
%dev.quarkus.compose.devservices.enabled=true
%dev.quarkus.compose.devservices.files=${user.home}/.pipeline/compose-devservices.yml
%dev.quarkus.compose.devservices.project-name=pipeline-shared-devservices
%dev.quarkus.compose.devservices.start-services=true
%dev.quarkus.compose.devservices.stop-services=false
%dev.quarkus.compose.devservices.reuse-project-for-tests=true

# Dev Services - Disable standalone datasource devservices since we're using Compose Dev Services
# The compose PostgreSQL service will be used instead
#%dev.quarkus.datasource.devservices.enabled=false
#
# Database configuration for dev mode (using dedicated database from compose)
%dev.quarkus.datasource.username=pipeline
%dev.quarkus.datasource.password=password
%dev.quarkus.datasource.jdbc.url=jdbc:postgresql://localhost:5432/platform_registration
%dev.quarkus.datasource.reactive.url=postgresql://localhost:5432/platform_registration

# PostgreSQL via Quarkus DevServices for tests
# DevServices will automatically configure datasource URLs, username, and password
%test.quarkus.datasource.devservices.enabled=true
%test.quarkus.datasource.devservices.image-name=postgres:16
%test.quarkus.datasource.devservices.db-name=platform_registration_test

# Hibernate
quarkus.hibernate-orm.schema-management.strategy=none
quarkus.hibernate-orm.mapping.format.global=ignore

# Flyway - runs migrations on startup
quarkus.flyway.migrate-at-start=true
quarkus.flyway.repair-at-start=false

# Consul (optional)
pipeline.consul.enabled=true
quarkus.consul-config.enabled=false
quarkus.stork.my-service.service-discovery.type=consul

# Dynamic gRPC Extension Configuration (replaces local dynamic-grpc client implementation)
quarkus.dynamic-grpc.consul.host=${CONSUL_HOST:localhost}
quarkus.dynamic-grpc.consul.port=${CONSUL_PORT:8500}
quarkus.dynamic-grpc.consul.refresh-period=10s
quarkus.dynamic-grpc.consul.use-health-checks=false

# Channel pool configuration
quarkus.dynamic-grpc.channel.idle-ttl-minutes=15
quarkus.dynamic-grpc.channel.max-size=1000
quarkus.dynamic-grpc.channel.shutdown-timeout-seconds=2

# Metrics
quarkus.micrometer.export.prometheus.enabled=true

# Kafka for OpenSearch Events
# Kafka Bootstrap Servers are configured per profile or via Dev Services
%dev.kafka.bootstrap.servers=localhost:9094
%prod.kafka.bootstrap.servers=kafka:9092
# Test: DevServices auto-configures kafka.bootstrap.servers

# OpenSearch Event Channels
# Note: Connector ('smallrye-kafka') and Serializers (ProtobufKafkaSerializer/UUIDSerializer) are
# AUTO-CONFIGURED by the quarkus-apicurio-registry-protobuf extension.
# We only need to specify the topic if it differs from the channel name.
mp.messaging.outgoing.opensearch-service-registered-events-producer.topic=opensearch-service-registered
mp.messaging.outgoing.opensearch-service-unregistered-events-producer.topic=opensearch-service-unregistered
mp.messaging.outgoing.opensearch-module-registered-events-producer.topic=opensearch-module-registered
mp.messaging.outgoing.opensearch-module-unregistered-events-producer.topic=opensearch-module-unregistered

# Test Channels
%test.mp.messaging.outgoing.test-events-out.topic=test-events
%test.mp.messaging.incoming.test-events-in.topic=test-events
# Apicurio Registry URL auto-configured by DevServices



# Quinoa Configuration (Vue.js UI)

# Logging
quarkus.log.level=INFO
quarkus.log.category."ai.pipestream.registry".level=INFO
%dev.quarkus.log.console.level=INFO
%dev.quarkus.log.category."io.quarkus.grpc".level=WARN
%dev.quarkus.log.category."io.smallrye.stork".level=WARN

# File logging configuration
%dev.quarkus.log.file.enabled=true
%dev.quarkus.log.file.path=logs/platform-registration-service.log
%dev.quarkus.log.file.level=DEBUG
%dev.quarkus.log.file.format=%d{yyyy-MM-dd HH:mm:ss,SSS} %-5p [%c{3.}] (%t) %s%e%n
%dev.quarkus.log.file.rotation.max-file-size=10M
%dev.quarkus.log.file.rotation.max-backup-index=10

# Service Registration Configuration
# ======================================================================================================================
service.registration.enabled=true
service.registration.service-name=platform-registration-service
service.registration.description=Platform service registration and discovery service
service.registration.service-type=APPLICATION
# Advertised host: what clients use to connect (e.g., host.docker.internal for Docker Desktop)
service.registration.host=${SERVICE_REGISTRATION_ADVERTISED_HOST:host.docker.internal}
service.registration.port=${quarkus.http.port}
# Internal host: what Consul uses for health checks (Docker bridge IP, e.g., 172.17.0.1)
service.registration.internal-host=${SERVICE_REGISTRATION_INTERNAL_HOST:172.17.0.1}
service.registration.capabilities=platform-registration,service-discovery
service.registration.tags=grpc,core-service,registration
%test.service.registration.enabled=false

# Use service discovery for registration service
pipeline.registration.discovery-name=platform-registration-service

# ======================================================================================================================
# Native Image Configuration
# ======================================================================================================================
# Initialize Netty/Vertx classes at runtime (not build time) to fix native image build
# Use package-level initialization for broader coverage
quarkus.native.additional-build-args=\
  --initialize-at-run-time=io.netty.channel,\
  --initialize-at-run-time=io.netty.util.concurrent,\
  --initialize-at-run-time=io.netty.handler.codec,\
  --initialize-at-run-time=io.netty.handler.ssl,\
  --initialize-at-run-time=io.netty.util.internal

# Enable HTTPS URL handler for native
quarkus.native.enable-https-url-handler=true
