# Application
quarkus.application.name=platform-registration-service
quarkus.application.version=@version@

%dev.kafka.bootstrap.servers=localhost:9094
%test.kafka.bootstrap.servers=localhost:9095
# Enable Compose Dev Services for tests
%test.quarkus.compose.devservices.enabled=true
%test.quarkus.compose.devservices.files=src/test/resources/compose-test-services.yml
%test.quarkus.compose.devservices.start-services=true
%test.quarkus.compose.devservices.stop-services=true

# Random port for test
quarkus.http.test-port=0

# Apicurio Registry URL
# Extension automatically bridges apicurio.registry.url to mp.messaging.connector.smallrye-kafka.apicurio.registry.url
# However, explicit mapping is required when disabling Dev Services
#mp.messaging.connector.smallrye-kafka.apicurio.registry.url=${apicurio.registry.url}
#%dev.apicurio.registry.url=http://localhost:8081
%test.apicurio.registry.url=http://localhost:8082/apis/registry/v3
%prod.apicurio.registry.url=${APICURIO_REGISTRY_URL}

# Container Image Configuration
quarkus.container-image.registry=ghcr.io
quarkus.container-image.group=ai-pipestream
quarkus.container-image.name=platform-registration-service
quarkus.container-image.tag=latest
# Version-based tag is set at build time via Gradle parameter instead of token replacement
# quarkus.container-image.additional-tags=@version@

# gRPC uses same server as HTTP
quarkus.grpc.server.use-separate-server=false
quarkus.grpc.server.enable-health-service=true

# Enable gRPC code generation from Buf-fetched proto files
# Proto files are exported to src/main/proto by syncProtos task
quarkus.grpc.codegen.skip=false
#
# Parent-first artifacts (gRPC, Protobuf, etc.) are automatically configured by pipeline-protobuf-kafka-connector extension
# No manual configuration needed - the extension handles all classloading automatically

# HTTP Configuration (also serves gRPC)
quarkus.http.port=38101
quarkus.http.root-path=/platform-registration
%dev.quarkus.http.port=38101
%dev.quarkus.http.host=0.0.0.0

# Database
quarkus.datasource.db-kind=mysql

# Dev Services timeout
%dev.quarkus.devservices.timeout=120s

# Note: The quarkus-pipeline-devservices extension extracts the compose file to ~/.pipeline/
# but does NOT configure Quarkus Compose Dev Services automatically. You must add the properties below.

# Compose Dev Services - Enable shared infrastructure for dev mode
%dev.quarkus.compose.devservices.enabled=true
%dev.quarkus.compose.devservices.files=${user.home}/.pipeline/compose-devservices.yml
%dev.quarkus.compose.devservices.project-name=pipeline-shared-devservices
%dev.quarkus.compose.devservices.start-services=true
%dev.quarkus.compose.devservices.stop-services=false
%dev.quarkus.compose.devservices.reuse-project-for-tests=true

# Dev Services - Disable standalone datasource devservices since we're using Compose Dev Services
# The compose MySQL service will be used instead (labeled quarkus-dev-service-mysql: shared)
#%dev.quarkus.datasource.devservices.enabled=false
#
## Database configuration for dev mode (using the shared MySQL from compose)
%dev.quarkus.datasource.username=pipeline
%dev.quarkus.datasource.password=password
%dev.quarkus.datasource.jdbc.url=jdbc:mysql://localhost:3306/pipeline
%dev.quarkus.datasource.reactive.url=mysql://localhost:3306/pipeline



# Hibernate
quarkus.hibernate-orm.schema-management.strategy=none
quarkus.hibernate-orm.mapping.format.global=ignore
quarkus.flyway.migrate-at-start=true
quarkus.flyway.repair-at-start=true

# Consul (optional)
pipeline.consul.enabled=true
quarkus.consul-config.enabled=false
quarkus.stork.my-service.service-discovery.type=consul

# Metrics
quarkus.micrometer.export.prometheus.enabled=true

# Kafka for OpenSearch Events
# Kafka Bootstrap Servers are configured via environment variables or Dev Services
kafka.bootstrap.servers=localhost:9094
%prod.kafka.bootstrap.servers=kafka:9092

# OpenSearch Event Channels (extension auto-configures Protobuf serializers)
mp.messaging.outgoing.opensearch-service-registered-events-producer.connector=smallrye-kafka
mp.messaging.outgoing.opensearch-service-registered-events-producer.topic=opensearch-service-registered
mp.messaging.outgoing.opensearch-service-unregistered-events-producer.connector=smallrye-kafka
mp.messaging.outgoing.opensearch-service-unregistered-events-producer.topic=opensearch-service-unregistered
mp.messaging.outgoing.opensearch-module-registered-events-producer.connector=smallrye-kafka
mp.messaging.outgoing.opensearch-module-registered-events-producer.topic=opensearch-module-registered
mp.messaging.outgoing.opensearch-module-unregistered-events-producer.connector=smallrye-kafka
mp.messaging.outgoing.opensearch-module-unregistered-events-producer.topic=opensearch-module-unregistered

# Test Channels (extension auto-configures Protobuf serializers)
%test.mp.messaging.outgoing.test-events-out.connector=smallrye-kafka
%test.mp.messaging.outgoing.test-events-out.topic=test-events
%test.mp.messaging.incoming.test-events-in.connector=smallrye-kafka
%test.mp.messaging.incoming.test-events-in.topic=test-events



# Quinoa Configuration (Vue.js UI)

# Logging
quarkus.log.level=INFO
quarkus.log.category."ai.pipestream.registry".level=INFO
%dev.quarkus.log.console.level=INFO
%dev.quarkus.log.category."io.quarkus.grpc".level=WARN
%dev.quarkus.log.category."io.smallrye.stork".level=WARN

# File logging configuration
%dev.quarkus.log.file.enabled=true
%dev.quarkus.log.file.path=logs/platform-registration-service.log
%dev.quarkus.log.file.level=DEBUG
%dev.quarkus.log.file.format=%d{yyyy-MM-dd HH:mm:ss,SSS} %-5p [%c{3.}] (%t) %s%e%n
%dev.quarkus.log.file.rotation.max-file-size=10M
%dev.quarkus.log.file.rotation.max-backup-index=10

# ======================================================================================================================
# Service Registration Configuration
# ======================================================================================================================
service.registration.enabled=true
service.registration.service-name=platform-registration-service
service.registration.description=Platform service registration and discovery service
service.registration.service-type=APPLICATION
service.registration.host=${PLATFORM_REGISTRATION_HOST:host.docker.internal}
service.registration.port=${quarkus.http.port}
service.registration.capabilities=platform-registration,service-discovery
service.registration.tags=grpc,core-service,registration
%test.service.registration.enabled=false

# Use service discovery for registration service
pipeline.registration.discovery-name=platform-registration-service
